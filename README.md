# Incentives API

Lifts the javascript logic from policy-hub and packages it up with Fastify.

Exposes /api/v1/calculator and describes query params and responses using OpenAPI.

Includes scripts to import data into a sqlite database.

## Architecture

The node.js file is packaged in a Docker container to allow installing sqlite in Cloud Run.

The Cloud Run services are not intended to be hit directly, we use zuplo.com as an API gateway. Zuplo performs the following functions for us:
 - documentation generation and hosting at /docs
 - API key management and authentication (and tracking for leaks)
 - rate limiting
 - CORS support for browsers

In production, this app responds to api.rewiringamerica.org via a CNAME that points to Zuplo.

At the moment, @tomc is the only team member with access to Zuplo at https://portal.zuplo.com/ - changes to configurations can also be made via git at https://github.com/rewiringamerica/incentives-api-zuplo

Zuplo authenticates developers using Auth0. @tomc, @derek, @tomm and @chell have access to Auth0.

## Deploys

Container is deployable on Google Cloud Run with `yarn deploy:dev` or `yarn deploy:production`.

Pushing to `main` branch will build the `rewiring-america-dev` project automatically, but the build does not yet autodeploy.
Merging a pull request from `main` to `production` branch will build the production project automatically, but the build does not yet autodeploy.

## Scaling

 * `gcloud run services update incentives-api --project rewiring-america --min-instances 1 --max-instances 10 --concurrency 100`

See Google's [concurrency guide](https://cloud.google.com/run/docs/about-concurrency) to learn more.

## URLs

 - Production api.rewiringamerica.org --> Zuplo --> https://incentives-api-w4dlpicepa-uc.a.run.app
 - Staging Zuplo --> https://incentives-api-dev-mcifvvqcxa-uc.a.run.app

## TODO

 * put these TODOs into Asana
 * finalize path, request, response formats
  * Do we expand HEEHR in the JSON? Does Hope for Homes have an ID?
  * finalize how to handle translations https://medium.com/@guillaume.viguierjust/building-a-multilingual-restful-api-2678add7febe
  * decide if incentives have ids, do programs have ids?
 * add tests for API and port calculation tests from policy-hub
 * use in existing calculator and remove calculation logic and data from website repo
 * set autoscaling rules and capacity rules on Cloud Run in dev and prod
 * what's the right content type for the yaml spec?
 * migrate any other lingering business logic from frontend (work with Derek)
 * think about metrics - what to record per client, where to (amplitude? bigquery) - should be possible from Zuplo
 * cache the openapi json/yaml files (or publish them somewhere at build time?)
 * protect the dev environment with a VPN (Tailscale?) or similar (use gcloud cli to proxy?)
 * should API accept tracts? address? https://geocoding.geo.census.gov/geocoder/
 * switch to typescript, generate types from schema https://www.fastify.io/docs/latest/Reference/TypeScript/
 * can we make the Cloud Run services private and give Zuplo keys to hit them? https://zuplo.com/docs/policies/upstream-gcp-jwt-inbound
 * cleanup readme.com
 * cleanup fly.io
 * link to changelog from Zuplo? https://www.rewiringamerica.org/app/changelog

## Notes

Why fastify? Seems like included schema validation is clean. Was a sqlite example at glitch.com, just ran with it! https://www.fastify.io/docs/latest/

The OpenAPI spec generated by this project isn't 100% valid due to discrepancies between JSON Schema and Open API. These should be fixed in OpenAPI 3.1
 - https://openap.is/validate?url=http%3A%2F%2Fincentives-api-dev-mcifvvqcxa-uc.a.run.app%2Fspec.json

The schema generated by Zuplo seems good, but it doesn't validate either:
 - https://openap.is/validate?url=https%3A%2F%2Fcustomer-assets-production.zuplo.dev%2Fe0c4d415-2834-400c-b6fa-b9d212af7aa7%2Fopen-api%2Fapi%2Fv1%2Fopen-api.json


## References

 - https://cloud.google.com/files/apigee/apigee-web-api-design-the-missing-link-ebook.pdf
 - https://techbeacon.com/app-dev-testing/you-need-api-management-help-11-open-source-tools-consider
 - https://zuplo.com/blog/2022/12/01/api-key-authentication
 - https://blog.readme.com/http-api-faux-pas/
 - https://medium.com/@guillaume.viguierjust/building-a-multilingual-restful-api-2678add7febe
